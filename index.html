<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>IPFS Share</title>
  <style>
    body{font-family:sans-serif;max-width:600px;margin:40px auto;padding:0 20px;text-align:center;background:#f5f7ff;color:#333}
    @media (prefers-color-scheme:dark){body{background:#1a1d29;color:#eaeff7}}
    h1{margin:0 0 20px;font-size:1.8rem}
    .drop{border:2px dashed #ccc;border-radius:12px;padding:30px;margin:20px 0;cursor:pointer}
    .drop:hover{border-color:#6366f1}
    input[type=file]{display:none}
    button{background:#6366f1;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin:10px}
    #link{width:100%;padding:10px;margin:15px 0;border:1px solid #ddd;border-radius:6px;background:transparent;color:inherit}
    .status{color:#ef4444;font-size:0.9em}
  </style>
</head>
<body>
  <h1>ğŸŒŒ IPFS Share</h1>
  <div class="drop" id="drop">ğŸ“ Drop file or click to browse</div>
  <input type="file" id="f" />
  <button id="share" disabled>ğŸ“¤ Share via IPFS</button>
  <input type="text" id="link" readonly placeholder="IPFS link appears here" />
  <div class="status" id="s"></div>

  <script type="module">
    import { create } from 'https://unpkg.com/ipfs@0.22.0/dist/index.min.js';
    const drop = document.getElementById('drop');
    const fIn = document.getElementById('f');
    const shareBtn = document.getElementById('share');
    const linkIn = document.getElementById('link');
    const status = document.getElementById('s');
    let file;

    drop.onclick = () => fIn.click();
    fIn.onchange = e => { file = e.target.files[0]; shareBtn.disabled = !file; };
    drop.ondragover = e => { e.preventDefault(); drop.style.borderColor = '#6366f1'; };
    drop.ondragleave = () => drop.style.borderColor = '#ccc';
    drop.ondrop = e => { e.preventDefault(); drop.style.borderColor = '#ccc'; file = e.dataTransfer.files[0]; shareBtn.disabled = !file; };

    let ipfs;
    try {
      ipfs = await create({ repo: 'ipfs-' + Math.random() });
      status.textContent = '';
    } catch (err) {
      status.textContent = 'âš ï¸ IPFS init failed (normal on HTTP)';
    }

    shareBtn.onclick = async () => {
      if (!file || !ipfs) return;
      status.textContent = 'Adding to IPFS...';
      try {
        const { cid } = await ipfs.add(new Uint8Array(await file.arrayBuffer()));
        const url = `${location.origin}${location.pathname}?cid=${cid.toString()}`;
        linkIn.value = url;
        await navigator.clipboard.writeText(url);
        status.textContent = 'âœ… Shared! Send this link.';
        status.style.color = '#10b981';
      } catch (err) {
        status.textContent = 'âŒ Failed: ' + (err.message || err);
        status.style.color = '#ef4444';
      }
    };

    const params = new URLSearchParams(location.search);
    const cid = params.get('cid');
    if (cid) {
      // Redirect to public IPFS gateway for reliable download
      const gatewayUrl = `https://dweb.link/ipfs/${cid}`;
      document.body.innerHTML = `<h1>ğŸ“¥ Downloading...</h1><p>From IPFS network via dweb.link</p><a href="${gatewayUrl}" style="display:block;margin-top:20px;color:#6366f1">ğŸ”— Direct Link</a>`;
      window.location.href = gatewayUrl;
    }
  </script>
</body>
</html>
